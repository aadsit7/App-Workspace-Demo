<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Recast — Application Delivery Flow (Fixed)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Confetti (optional; guarded in JS) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
      :root {
        --route: #2563eb; /* blue-600 */
        --route-soft: rgba(37, 99, 235, 0.18);
        --good: #10b981; /* emerald-500 */
        --muted: #64748b; /* slate-500 */
      }

      /* Pulse tiles */
      @keyframes tilePulse {
        0% {
          transform: scale(0.82);
          opacity: 0.45;
          background-color: #e5e7eb;
        }
        60% {
          transform: scale(1);
          opacity: 1;
          background-color: #2563eb;
        }
        100% {
          transform: scale(0.92);
          opacity: 0.9;
          background-color: #e5e7eb;
        }
      }

      /* Route draw (stroke-dashoffset) */
      @keyframes routeDraw {
        to {
          stroke-dashoffset: 0;
        }
      }

      /* Control plane ping */
      @keyframes pingSoft {
        0% {
          transform: translate(-50%, -50%) scale(0.6);
          opacity: 0;
        }
        35% {
          opacity: 0.7;
        }
        100% {
          transform: translate(-50%, -50%) scale(1.35);
          opacity: 0;
        }
      }

      /* Rider subtle bob */
      @keyframes riderBob {
        0%,
        100% {
          transform: translate(var(--x, 0px), var(--y, 0px)) rotate(var(--r, 0deg));
        }
        50% {
          transform: translate(var(--x, 0px), calc(var(--y, 0px) - 2px)) rotate(var(--r, 0deg));
        }
      }

      /* “Framework” hook: toggle .run on #flowCard to animate tiles */
      .run [data-anim="tile"] {
        animation: tilePulse 0.9s ease-in-out var(--d, 0s) 1 forwards;
      }

      /* Route layer */
      .route-layer {
        position: absolute;
        inset: 0;
        pointer-events: none;
        z-index: 1; /* behind content */
      }

      .route-svg {
        width: 100%;
        height: 100%;
        display: block;
      }

      /* The faint “glow” route */
      .route-glow {
        fill: none;
        stroke: var(--route-soft);
        stroke-width: 14;
        stroke-linecap: round;
      }

      /* The main dashed trace */
      .route-trace {
        fill: none;
        stroke: var(--route);
        stroke-width: 4;
        stroke-linecap: round;
        stroke-dasharray: 10 10;
        stroke-dashoffset: 1; /* will be set dynamically */
        opacity: 0;
      }

      /* Rider */
      .rider {
        position: absolute;
        left: 0;
        top: 0;
        z-index: 3; /* above route + content */
        width: 38px;
        height: 38px;
        border-radius: 999px;
        background: white;
        box-shadow:
          0 10px 22px rgba(15, 23, 42, 0.12),
          inset 0 0 0 1px rgba(15, 23, 42, 0.08);
        display: grid;
        place-items: center;
        opacity: 0;
        transform: translate(0, 0);
      }

      .rider svg {
        width: 22px;
        height: 22px;
      }

      /* Control plane marker */
      .control-marker {
        position: absolute;
        z-index: 2;
        width: 12px;
        height: 12px;
        border-radius: 999px;
        background: var(--route);
        box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.14);
        opacity: 0;
        transform: translate(-50%, -50%);
        pointer-events: none;
      }

      .control-ping {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 34px;
        height: 34px;
        border-radius: 999px;
        background: rgba(37, 99, 235, 0.16);
        transform: translate(-50%, -50%) scale(0.6);
        opacity: 0;
      }

      .processed {
        background-color: #ecfdf5 !important;
        border-color: #d1fae5 !important;
        color: #065f46 !important;
      }

      .dimmed {
        opacity: 0.55;
        transition: opacity 200ms ease;
      }

      .highlighted {
        border-color: var(--good) !important;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.22);
        transition: box-shadow 200ms ease, border-color 200ms ease;
      }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce) {
        .run [data-anim="tile"] {
          animation: none !important;
        }
        .route-trace {
          animation: none !important;
        }
        .rider {
          animation: none !important;
        }
      }
    </style>
  </head>

  <body class="min-h-screen antialiased bg-gray-50 text-gray-900 font-[Inter]">
    <div class="mx-auto max-w-6xl px-6 lg:px-12 pt-8 pb-8">
      <h1 class="text-4xl md:text-5xl font-semibold leading-tight">
        <span class="text-blue-600">Re</span><span>cast Application Workspace</span>
      </h1>
      <p class="mt-2 max-w-3xl text-base leading-relaxed text-gray-700">
        The rider visibly delivers from apps → control plane → end user. Confetti lands after processing completes.
      </p>

      <div class="mt-6 rounded-2xl bg-white shadow-md p-4">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <div class="h-9 w-9 rounded-xl bg-blue-600 grid place-items-center">
              <i data-lucide="layers" class="w-5 h-5 text-white"></i>
            </div>
            <div>
              <div class="font-semibold">Application Delivery Flow</div>
              <div class="text-[12px] text-gray-600">Motorcycle delivery + staged policy routing</div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button
              id="btnStart"
              type="button"
              class="bg-blue-600 text-white px-4 py-2 text-sm font-semibold rounded-full hover:bg-blue-700 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2 disabled:opacity-60 disabled:hover:bg-blue-600"
            >
              Start
            </button>
            <button
              id="btnReset"
              type="button"
              class="bg-transparent text-gray-900 border-2 border-gray-900 px-4 py-2 text-sm font-semibold rounded-full hover:text-blue-600 hover:border-blue-600 focus-visible:ring-2 focus-visible:ring-blue-600 focus-visible:ring-offset-2"
            >
              Reset
            </button>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-center gap-3 text-[13px] font-medium">
          <div class="flex items-center gap-1">
            <i data-lucide="building" class="w-4.5 h-4.5 text-gray-700"></i>
            <span>Existing App Managers</span>
          </div>
          <i data-lucide="arrow-right" class="w-4.5 h-4.5 text-gray-500"></i>
          <div class="flex items-center gap-1">
            <i data-lucide="workflow" class="w-4.5 h-4.5 text-blue-600"></i>
            <span>Delivery Control Plane</span>
          </div>
          <i data-lucide="arrow-right" class="w-4.5 h-4.5 text-gray-500"></i>
          <div class="flex items-center gap-1">
            <i data-lucide="user" class="w-4.5 h-4.5 text-gray-700"></i>
            <span>User</span>
          </div>
        </div>

        <div class="mt-3 text-center bg-blue-50 p-2 rounded-lg text-[12px] text-gray-700">
          Recast sits between your tools and your users, standardizing delivery without changing where apps come from.
        </div>

        <!-- FLOW CARD -->
        <div
          id="flowCard"
          class="mt-4 relative rounded-2xl border border-gray-200 bg-gradient-to-b from-white to-gray-50 shadow-inner p-4 overflow-hidden"
        >
          <!-- Route + rider (absolute, behind content) -->
          <div class="route-layer" aria-hidden="true">
            <svg id="routeSvg" class="route-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
              <path id="routeGlow" class="route-glow" d=""></path>
              <path id="routeTrace" class="route-trace" d=""></path>
            </svg>

            <div id="controlMarker" class="control-marker">
              <div id="controlPing" class="control-ping"></div>
            </div>

            <div id="rider" class="rider">
              <!-- Simple “motorcycle” icon (inline SVG, no external dependency) -->
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path
                  d="M7.5 16.5a2.5 2.5 0 1 0 0 .01V16.5Zm11 0a2.5 2.5 0 1 0 0 .01V16.5Z"
                  stroke="#0f172a"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M7.5 16.5h4.6a3 3 0 0 0 2.7-1.7l1.4-2.8h2.3"
                  stroke="#2563eb"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M11.2 9.2h2.6l1.8 3.2"
                  stroke="#0f172a"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
                <path
                  d="M10 9.2 8.8 7.2H6.2"
                  stroke="#0f172a"
                  stroke-width="1.6"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </div>
          </div>

          <!-- CONTENT (above route) -->
          <div class="relative z-10">
            <div id="progressCounters" class="grid grid-cols-3 gap-2 text-[13px] text-center mb-4">
              <div>
                <div class="text-gray-500 text-[11px]">apps processed</div>
                <div class="font-semibold tabular-nums" id="appsProcessed">0</div>
              </div>
              <div>
                <div class="text-gray-500 text-[11px]">hours saved</div>
                <div class="font-semibold tabular-nums" id="timeSaved">0</div>
              </div>
              <div>
                <div class="text-gray-500 text-[11px]">tickets avoided</div>
                <div class="font-semibold tabular-nums" id="ticketsAvoided">0</div>
              </div>
            </div>

            <div class="space-y-3">
              <div class="grid grid-cols-[8ch_1fr] gap-3 items-start border-t border-gray-200 pt-3 first:border-t-0 first:pt-0">
                <div class="text-[11px] uppercase text-gray-700 flex items-center gap-1.5">
                  <i data-lucide="folder" class="w-3 h-3"></i><span>Core</span>
                </div>
                <div id="catCore" class="flex flex-wrap gap-2"></div>
              </div>

              <div class="grid grid-cols-[8ch_1fr] gap-3 items-start border-t border-gray-200 pt-3">
                <div class="text-[11px] uppercase text-gray-700 flex items-center gap-1.5">
                  <i data-lucide="folder" class="w-3 h-3"></i><span>Security</span>
                </div>
                <div id="catSecurity" class="flex flex-wrap gap-2"></div>
              </div>

              <div class="grid grid-cols-[8ch_1fr] gap-3 items-start border-t border-gray-200 pt-3">
                <div class="text-[11px] uppercase text-gray-700 flex items-center gap-1.5">
                  <i data-lucide="folder" class="w-3 h-3"></i><span>Enterprise</span>
                </div>
                <div id="catEnterprise" class="flex flex-wrap gap-2"></div>
              </div>
            </div>

            <!-- Middle buckets (generated by JS; no template leakage) -->
            <div class="mt-4 grid grid-cols-3 gap-2" aria-hidden="true">
              <div id="platformsSection" class="space-y-2"></div>
              <div id="groupsSection" class="space-y-2"></div>
              <div id="devicesSection" class="space-y-2"></div>
            </div>

            <!-- End user -->
            <div id="endUserCard" class="mt-4 rounded-2xl border border-gray-200 bg-gray-50 p-3">
              <div class="flex items-center gap-2">
                <div id="endUserAvatar" class="h-9 w-9 grid place-items-center font-semibold rounded-full bg-red-600 text-white">
                  U
                </div>
                <div class="text-[13px]">
                  <div class="font-medium">End user</div>
                  <div id="endUserMessage" class="text-gray-700">
                    Waiting for delivery…
                  </div>
                </div>
              </div>

              <div class="mt-2 text-[12px] text-gray-600">
                Right app, right policy, right device — regardless of backend platform.
              </div>
            </div>

            <div id="flowSuccess" class="mt-3 hidden items-center gap-2 text-[13px] text-green-600 font-medium">
              <i data-lucide="sparkles" class="w-4 h-4"></i>
              <span>Configured once → delivered everywhere.</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ---------- Helpers ----------
      const prefersReduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      const $ = (sel, root = document) => root.querySelector(sel);

      function safeCreateIcons() {
        try { window.lucide && window.lucide.createIcons && window.lucide.createIcons(); } catch {}
      }

      function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

      function confettiBurst() {
        if (typeof window.confetti !== "function") return;
        // tasteful, not a fireworks show
        window.confetti({
          particleCount: 110,
          spread: 65,
          startVelocity: 32,
          scalar: 0.9,
          origin: { x: 0.6, y: 0.18 },
        });
        window.confetti({
          particleCount: 75,
          spread: 55,
          startVelocity: 28,
          scalar: 0.85,
          origin: { x: 0.45, y: 0.2 },
        });
      }

      // ---------- Data (simple + deterministic) ----------
      const CATALOG = {
        core: [
          { label: "W", bg: "#E6F0FF" },
          { label: "X", bg: "#E9F7EF" },
          { label: "P", bg: "#FFEFE8" },
          { label: "O", bg: "#E6F3FF" },
          { label: "T", bg: "#F0EEFF" },
          { label: "G", bg: "#FFECEC" },
        ],
        security: [
          { label: "D", bg: "#EAFBF2" },
          { label: "O", bg: "#E6F3FF" },
          { label: "P", bg: "#FFECEC" },
          { label: "A", bg: "#E6F0FF" },
          { label: "M", bg: "#E6F3FF" },
          { label: "C", bg: "#FFECEC" },
        ],
        enterprise: [
          { label: "S", bg: "#E6F3FF" },
          { label: "W", bg: "#E6F0FF" },
          { label: "S", bg: "#E6F3FF" },
          { label: "N", bg: "#EAFBF2" },
        ],
      };

      const BUCKETS = {
        platforms: ["Existing Platforms", "Staged Rings", "Access & Policy"],
        groups: ["Business Unit", "Subsidiary", "Region"],
        devices: ["Windows & macOS", "VDI / Web", "Mobile"],
      };

      // ---------- State ----------
      let running = false;
      let timers = [];
      let progressTimer = null;

      const progress = { apps: 0, time: 0, tickets: 0 };
      const progressCap = { apps: 128, time: 46, tickets: 73 };

      function clearTimers() {
        timers.forEach((t) => clearTimeout(t));
        timers = [];
        if (progressTimer) clearInterval(progressTimer);
        progressTimer = null;
      }

      function setCounter(id, v) {
        const el = document.getElementById(id);
        if (el) el.textContent = String(v);
      }

      function resetCounters() {
        progress.apps = 0;
        progress.time = 0;
        progress.tickets = 0;
        setCounter("appsProcessed", 0);
        setCounter("timeSaved", 0);
        setCounter("ticketsAvoided", 0);
      }

      // ---------- Build UI ----------
      function buildCatalog() {
        const makeIcon = (item, idx, kind) => {
          const d = document.createElement("div");
          d.className =
            "app-icon w-9 h-9 rounded-full grid place-items-center font-semibold text-[12px] text-slate-900 shadow-[inset_0_0_0_1px_rgba(0,0,0,0.10)]";
          d.style.background = item.bg;
          d.textContent = item.label;

          // Anchor for route start: first icon in CORE
          if (kind === "core" && idx === 0) d.id = "startAnchor";

          return d;
        };

        const core = $("#catCore");
        const sec = $("#catSecurity");
        const ent = $("#catEnterprise");
        core.innerHTML = "";
        sec.innerHTML = "";
        ent.innerHTML = "";

        CATALOG.core.forEach((it, i) => core.appendChild(makeIcon(it, i, "core")));
        CATALOG.security.forEach((it, i) => sec.appendChild(makeIcon(it, i, "security")));
        CATALOG.enterprise.forEach((it, i) => ent.appendChild(makeIcon(it, i, "enterprise")));
      }

      function buildBucketColumn(title) {
        const wrap = document.createElement("div");
        wrap.className = "rounded-xl border border-gray-200 bg-gray-50 p-2";

        const head = document.createElement("div");
        head.className = "text-[11px] text-gray-700 mb-2";
        head.textContent = title;

        const grid = document.createElement("div");
        grid.className = "grid grid-cols-10 gap-1";

        for (let i = 0; i < 14; i++) {
          const tile = document.createElement("div");
          tile.className = "w-[0.42rem] h-[0.42rem] rounded-[2px] bg-gray-200 opacity-90";
          tile.setAttribute("data-anim", "tile");
          tile.style.setProperty("--d", (0.6 + i * 0.06).toFixed(2) + "s");
          grid.appendChild(tile);
        }

        wrap.appendChild(head);
        wrap.appendChild(grid);
        return wrap;
      }

      function buildBuckets() {
        const platforms = $("#platformsSection");
        const groups = $("#groupsSection");
        const devices = $("#devicesSection");
        platforms.innerHTML = "";
        groups.innerHTML = "";
        devices.innerHTML = "";

        BUCKETS.platforms.forEach((t) => platforms.appendChild(buildBucketColumn(t)));
        BUCKETS.groups.forEach((t) => groups.appendChild(buildBucketColumn(t)));
        BUCKETS.devices.forEach((t) => devices.appendChild(buildBucketColumn(t)));
      }

      // ---------- Route + rider geometry ----------
      function elementCenterWithin(el, within) {
        const r = el.getBoundingClientRect();
        const w = within.getBoundingClientRect();
        return {
          x: (r.left + r.right) / 2 - w.left,
          y: (r.top + r.bottom) / 2 - w.top,
        };
      }

      function setRoutePath() {
        const card = $("#flowCard");
        const start = $("#startAnchor");
        const end = $("#endUserAvatar");
        if (!card || !start || !end) return null;

        const w = card.clientWidth;
        const h = card.clientHeight;

        // Pixel coordinates within the card
        const s = elementCenterWithin(start, card);
        const e = elementCenterWithin(end, card);

        // Control plane waypoint: center-ish, biased upward to avoid end-user card text
        const mid = {
          x: clamp(w * 0.55, 0, w),
          y: clamp(h * 0.46, 0, h),
        };

        // Smooth cubic curve through mid
        const c1 = { x: clamp(s.x + w * 0.18, 0, w), y: clamp(s.y + h * 0.06, 0, h) };
        const c2 = { x: clamp(mid.x - w * 0.10, 0, w), y: clamp(mid.y - h * 0.08, 0, h) };

        const c3 = { x: clamp(mid.x + w * 0.10, 0, w), y: clamp(mid.y + h * 0.10, 0, h) };
        const c4 = { x: clamp(e.x - w * 0.18, 0, w), y: clamp(e.y - h * 0.06, 0, h) };

        const d = [
          `M ${s.x.toFixed(1)} ${s.y.toFixed(1)}`,
          `C ${c1.x.toFixed(1)} ${c1.y.toFixed(1)}, ${c2.x.toFixed(1)} ${c2.y.toFixed(1)}, ${mid.x.toFixed(1)} ${mid.y.toFixed(1)}`,
          `C ${c3.x.toFixed(1)} ${c3.y.toFixed(1)}, ${c4.x.toFixed(1)} ${c4.y.toFixed(1)}, ${e.x.toFixed(1)} ${e.y.toFixed(1)}`,
        ].join(" ");

        const svg = $("#routeSvg");
        const glow = $("#routeGlow");
        const trace = $("#routeTrace");

        // Match viewBox to pixel space so stroke widths stay sane
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
        glow.setAttribute("d", d);
        trace.setAttribute("d", d);

        // Place the control marker on the mid point
        const marker = $("#controlMarker");
        marker.style.left = mid.x + "px";
        marker.style.top = mid.y + "px";

        return { start: s, mid, end: e, pathD: d };
      }

      function animateRouteAndRider(totalMs = 7000) {
        const card = $("#flowCard");
        const trace = $("#routeTrace");
        const rider = $("#rider");
        const ping = $("#controlPing");
        const marker = $("#controlMarker");

        const geo = setRoutePath();
        if (!geo) return;

        // Make route visible
        trace.style.opacity = "1";

        // Compute dash length
        const length = trace.getTotalLength();
        trace.style.strokeDasharray = "10 10";
        trace.style.strokeDashoffset = String(length);

        // Draw animation
        if (!prefersReduced) {
          trace.style.animation = "none";
          // restart
          void trace.getBoundingClientRect();
          trace.style.animation = `routeDraw ${totalMs}ms linear forwards`;
        } else {
          trace.style.strokeDashoffset = "0";
        }

        // Rider appears at start
        rider.style.opacity = "1";

        // Rider movement: we approximate along 3 keyframes (start → mid → end).
        // This is stable and readable without doing heavy per-frame path sampling.
        const kf = [
          { offset: 0, x: geo.start.x, y: geo.start.y, r: "-8deg" },
          { offset: 0.55, x: geo.mid.x, y: geo.mid.y, r: "6deg" },
          { offset: 1, x: geo.end.x, y: geo.end.y, r: "0deg" },
        ];

        function applyRiderFrame(frame) {
          rider.style.setProperty("--x", (frame.x - 19).toFixed(1) + "px"); // center rider (38px)
          rider.style.setProperty("--y", (frame.y - 19).toFixed(1) + "px");
          rider.style.setProperty("--r", frame.r);
        }

        // Initial position
        applyRiderFrame(kf[0]);

        if (prefersReduced) {
          applyRiderFrame(kf[2]);
          return;
        }

        // Animate rider with Web Animations, plus a subtle bob
        const wa = rider.animate(
          kf.map((p) => ({
            transform: `translate(${(p.x - 19).toFixed(1)}px, ${(p.y - 19).toFixed(1)}px) rotate(${p.r})`,
            offset: p.offset,
          })),
          { duration: totalMs, easing: "cubic-bezier(0.2,0.8,0.2,1)", fill: "forwards" }
        );

        // Bob while moving
        rider.style.animation = "none";
        void rider.getBoundingClientRect();
        rider.style.animation = "riderBob 520ms ease-in-out infinite";

        // Control plane ping near the midpoint
        marker.style.opacity = "1";
        timers.push(
          setTimeout(() => {
            ping.style.opacity = "1";
            ping.style.animation = "none";
            void ping.getBoundingClientRect();
            ping.style.animation = "pingSoft 720ms ease-out 1";
          }, Math.floor(totalMs * 0.52))
        );

        wa.onfinish = () => {
          rider.style.animation = "none";
        };
      }

      // ---------- Flow steps ----------
      function markProcessed(selector, idx, delayMs) {
        timers.push(
          setTimeout(() => {
            const cols = Array.from(document.querySelectorAll(selector + " > .rounded-xl"));
            if (cols[idx]) cols[idx].classList.add("processed");
          }, delayMs)
        );
      }

      function startProgress(totalMs = 7000) {
        const start = performance.now();
        progressTimer = setInterval(() => {
          const t = clamp((performance.now() - start) / totalMs, 0, 1);

          // Ease counters up smoothly
          const ease = t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;

          setCounter("appsProcessed", Math.round(progressCap.apps * ease));
          setCounter("timeSaved", Math.round(progressCap.time * ease));
          setCounter("ticketsAvoided", Math.round(progressCap.tickets * ease));

          if (t >= 1) {
            clearInterval(progressTimer);
            progressTimer = null;
          }
        }, 60);
      }

      function startFlow() {
        if (running) return;
        running = true;

        const btnStart = $("#btnStart");
        btnStart.disabled = true;

        clearTimers();

        // Reset visual states before running
        $("#flowSuccess").classList.add("hidden");
        $("#endUserCard").classList.remove("highlighted");
        $("#groupsSection").classList.remove("dimmed");
        document.querySelectorAll(".processed").forEach((el) => el.classList.remove("processed"));

        $("#endUserAvatar").classList.remove("bg-green-500");
        $("#endUserAvatar").classList.add("bg-red-600");
        $("#endUserMessage").textContent = "Processing apps + policy…";

        // Trigger tile pulses
        const card = $("#flowCard");
        card.classList.remove("run");
        void card.getBoundingClientRect();
        card.classList.add("run");

        // Geometry depends on layout; compute after paint
        timers.push(
          setTimeout(() => {
            animateRouteAndRider(7000);
          }, 0)
        );

        // Progress counters
        resetCounters();
        startProgress(7000);

        // Stage processing (roughly synced to rider)
        markProcessed("#platformsSection", 0, 1800);
        markProcessed("#platformsSection", 1, 2400);
        markProcessed("#platformsSection", 2, 3000);

        markProcessed("#groupsSection", 0, 3600);
        markProcessed("#groupsSection", 1, 4200);
        markProcessed("#groupsSection", 2, 4800);

        markProcessed("#devicesSection", 0, 5200);
        markProcessed("#devicesSection", 1, 5600);
        markProcessed("#devicesSection", 2, 6000);

        // Highlight the end-user card as the rider nears delivery
        timers.push(
          setTimeout(() => {
            $("#groupsSection").classList.add("dimmed");
            $("#endUserCard").classList.add("highlighted");
          }, 5200)
        );

        // Complete delivery
        timers.push(
          setTimeout(() => {
            $("#endUserAvatar").classList.remove("bg-red-600");
            $("#endUserAvatar").classList.add("bg-green-500");
            $("#endUserMessage").textContent = "Delivered. User has the right app + policy immediately.";

            $("#flowSuccess").classList.remove("hidden");
            $("#flowSuccess").classList.add("inline-flex");

            confettiBurst();

            // stop rider bob if still running
            $("#rider").style.animation = "none";

            // allow restart
            running = false;
            btnStart.disabled = false;
          }, 7200)
        );
      }

      function resetFlow() {
        clearTimers();
        running = false;
        $("#btnStart").disabled = false;

        // Remove run state
        $("#flowCard").classList.remove("run");

        // Clear processed styles
        document.querySelectorAll(".processed").forEach((el) => el.classList.remove("processed"));
        $("#groupsSection").classList.remove("dimmed");
        $("#endUserCard").classList.remove("highlighted");

        // Reset user card
        $("#endUserAvatar").classList.remove("bg-green-500");
        $("#endUserAvatar").classList.add("bg-red-600");
        $("#endUserMessage").textContent = "Waiting for delivery…";
        $("#flowSuccess").classList.add("hidden");
        $("#flowSuccess").classList.remove("inline-flex");

        // Hide rider + clear route
        $("#rider").style.opacity = "0";
        $("#rider").style.animation = "none";

        $("#controlMarker").style.opacity = "0";
        $("#controlPing").style.opacity = "0";
        $("#controlPing").style.animation = "none";

        const trace = $("#routeTrace");
        const glow = $("#routeGlow");
        trace.style.opacity = "0";
        trace.style.animation = "none";
        trace.setAttribute("d", "");
        glow.setAttribute("d", "");

        // Counters
        resetCounters();
      }

      // Recompute route on resize (only matters after first run)
      let resizeTimer = null;
      window.addEventListener("resize", () => {
        if (resizeTimer) clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          if (running) setRoutePath();
        }, 100);
      });

      // ---------- Boot ----------
      document.addEventListener("DOMContentLoaded", () => {
        buildCatalog();
        buildBuckets();
        safeCreateIcons();

        $("#btnStart").addEventListener("click", startFlow);
        $("#btnReset").addEventListener("click", resetFlow);

        // Start in a clean state
        resetFlow();
      });
    </script>
  </body>
</html>
